{% extends "base.html" %}

{% block title %}Monitoreo & Administración{% endblock %}

{% block extra_css %}
<style>
    .admin-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: white;
    }
    
    .admin-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 15px rgba(0,123,255,0.1);
    }
    
    .status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
    }
    
    .status-healthy {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .status-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }
    
    .status-critical {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .alert-item {
        border-left: 4px solid;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .alert-critical { border-left-color: #dc3545; }
    .alert-high { border-left-color: #fd7e14; }
    .alert-medium { border-left-color: #ffc107; }
    .alert-low { border-left-color: #28a745; }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .integration-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
    }
    
    .integration-active {
        border-left: 4px solid #28a745;
    }
    
    .integration-inactive {
        border-left: 4px solid #dc3545;
    }
    
    .backup-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
    }
    
    .progress-bar-custom {
        height: 20px;
        border-radius: 10px;
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-online { background-color: #28a745; }
    .status-offline { background-color: #dc3545; }
    .status-warning { background-color: #ffc107; }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-cogs text-primary"></i> Monitoreo & Administración
                    </h1>
                    <p class="text-muted">Supervisión del sistema, integraciones y respaldos</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt"></i> Actualizar Todo
                    </button>
                    <button class="btn btn-success" onclick="startAllServices()">
                        <i class="fas fa-play"></i> Iniciar Servicios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado del Sistema -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-card">
                <h5 class="mb-3">
                    <i class="fas fa-heartbeat text-danger"></i> Estado de Salud del Sistema
                    <span class="badge badge-primary pulse" id="healthStatus">Actualizando...</span>
                </h5>
                <div class="row" id="systemHealthContainer">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card" id="overallStatusCard">
                            <div class="metric-value" id="overallStatus">-</div>
                            <div class="metric-label">Estado General</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card">
                            <div class="metric-value" id="performanceScore">-</div>
                            <div class="metric-label">Puntuación de Rendimiento</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card">
                            <div class="metric-value" id="uptime">-</div>
                            <div class="metric-label">Tiempo de Actividad</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card">
                            <div class="metric-value" id="activeAlerts">-</div>
                            <div class="metric-label">Alertas Activas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas del Sistema -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="admin-card">
                <h5 class="mb-3">
                    <i class="fas fa-chart-line text-info"></i> Métricas del Sistema
                </h5>
                <div class="chart-container">
                    <canvas id="metricsChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="admin-card">
                <h5 class="mb-3">
                    <i class="fas fa-bell text-warning"></i> Alertas Recientes
                </h5>
                <div id="recentAlerts">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando alertas...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Integraciones Externas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-card">
                <h5 class="mb-3">
                    <i class="fas fa-plug text-success"></i> Integraciones Externas
                    <div class="btn-group btn-group-sm float-right">
                        <button class="btn btn-outline-primary" onclick="syncMarketPrices()">
                            <i class="fas fa-sync"></i> Sincronizar Precios
                        </button>
                        <button class="btn btn-outline-success" onclick="syncSupplierData()">
                            <i class="fas fa-truck"></i> Sincronizar Proveedores
                        </button>
                        <button class="btn btn-outline-info" onclick="toggleAutoSync()">
                            <i class="fas fa-cog"></i> Auto Sincronización
                        </button>
                    </div>
                </h5>
                <div id="integrationsContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando integraciones...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Respaldos -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="admin-card">
                <h5 class="mb-3">
                    <i class="fas fa-database text-info"></i> Gestión de Respaldos
                </h5>
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="createFullBackup()">
                        <i class="fas fa-archive"></i> Respaldo Completo
                    </button>
                    <button class="btn btn-success" onclick="createDataBackup()">
                        <i class="fas fa-table"></i> Respaldo de Datos
                    </button>
                    <button class="btn btn-warning" onclick="cleanupBackups()">
                        <i class="fas fa-trash"></i> Limpiar Antiguos
                    </button>
                </div>
                <div id="backupStatus">
                    <div class="text-center text-muted">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <p>Información de respaldos</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="admin-card">
                <h5 class="mb-3">Respaldos Disponibles</h5>
                <div id="backupsList">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando respaldos...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración de Monitoreo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-card">
                <h5 class="mb-3">
                    <i class="fas fa-cog text-secondary"></i> Configuración de Monitoreo
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Reglas de Alertas</h6>
                        <div id="alertRules">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Cargando reglas...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Control de Servicios</h6>
                        <div class="mb-3">
                            <button class="btn btn-success" onclick="startMonitoring()">
                                <i class="fas fa-play"></i> Iniciar Monitoreo
                            </button>
                            <button class="btn btn-danger" onclick="stopMonitoring()">
                                <i class="fas fa-stop"></i> Detener Monitoreo
                            </button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-info" onclick="startAutoSync()">
                                <i class="fas fa-sync"></i> Iniciar Auto Sync
                            </button>
                            <button class="btn btn-warning" onclick="stopAutoSync()">
                                <i class="fas fa-pause"></i> Detener Auto Sync
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log de Actividad -->
    <div class="row">
        <div class="col-12">
            <div class="admin-card">
                <h5 class="mb-3">
                    <i class="fas fa-history text-secondary"></i> Log de Actividad del Sistema
                </h5>
                <div id="activityLog" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div class="text-muted">Esperando actividad del sistema...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};
let autoRefreshInterval;

// Cargar datos al inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadIntegrations();
    loadBackups();
    loadAlertRules();
    loadActiveAlerts();
    
    // Iniciar actualización automática
    startAutoRefresh();
});

function loadDashboardData() {
    fetch('/api/integration/monitoring/dashboard')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSystemHealth(data.dashboard.system_health);
                updateMetricsChart(data.dashboard.monitoring);
            }
        })
        .catch(error => console.error('Error cargando dashboard:', error));
}

function updateSystemHealth(health) {
    document.getElementById('overallStatus').textContent = health.status.toUpperCase();
    document.getElementById('performanceScore').textContent = health.performance_score.toFixed(1);
    document.getElementById('uptime').textContent = health.uptime.toFixed(1) + '%';
    document.getElementById('activeAlerts').textContent = health.alerts_count;
    
    // Actualizar color del estado
    const statusCard = document.getElementById('overallStatusCard');
    statusCard.className = 'status-card';
    
    if (health.status === 'healthy') {
        statusCard.classList.add('status-healthy');
    } else if (health.status === 'warning') {
        statusCard.classList.add('status-warning');
    } else if (health.status === 'critical') {
        statusCard.classList.add('status-critical');
    }
    
    document.getElementById('healthStatus').textContent = 'Actualizado';
    document.getElementById('healthStatus').className = 'badge badge-success';
}

function updateMetricsChart(monitoring) {
    const ctx = document.getElementById('metricsChart');
    if (!ctx) return;
    
    if (charts.metrics) {
        charts.metrics.destroy();
    }
    
    // Datos simulados para el gráfico
    const labels = ['CPU', 'Memoria', 'Disco', 'Red', 'DB'];
    const values = [45, 60, 75, 30, 85];
    
    charts.metrics = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Uso del Sistema (%)',
                data: values,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function loadIntegrations() {
    fetch('/api/integration/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayIntegrations(data.status);
            }
        })
        .catch(error => console.error('Error cargando integraciones:', error));
}

function displayIntegrations(status) {
    const container = document.getElementById('integrationsContainer');
    let html = '';
    
    Object.keys(status.integrations).forEach(name => {
        const integration = status.integrations[name];
        const statusClass = integration.status === 'active' ? 'integration-active' : 'integration-inactive';
        const statusIndicator = integration.status === 'active' ? 'status-online' : 'status-offline';
        
        html += `
            <div class="integration-item ${statusClass}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6>${integration.name}</h6>
                        <small class="text-muted">
                            <span class="status-indicator ${statusIndicator}"></span>
                            ${integration.status === 'active' ? 'Activo' : 'Inactivo'}
                        </small>
                        ${integration.last_sync ? `<br><small class="text-muted">Última sincronización: ${new Date(integration.last_sync).toLocaleString()}</small>` : ''}
                    </div>
                    <div>
                        <span class="badge badge-${integration.status === 'active' ? 'success' : 'secondary'}">
                            ${integration.status === 'active' ? 'Activo' : 'Inactivo'}
                        </span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadBackups() {
    fetch('/api/integration/backup/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBackupStatus(data.status);
                displayBackupsList(data.status.backups);
            }
        })
        .catch(error => console.error('Error cargando respaldos:', error));
}

function displayBackupStatus(status) {
    const container = document.getElementById('backupStatus');
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center">
                    <div class="metric-value text-primary">${status.total_backups}</div>
                    <div class="metric-label">Total Respaldos</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <div class="metric-value text-info">${(status.total_size / 1024 / 1024).toFixed(1)} MB</div>
                    <div class="metric-label">Tamaño Total</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <div class="metric-value text-warning">${status.retention_days}</div>
                    <div class="metric-label">Días de Retención</div>
                </div>
            </div>
        </div>
    `;
}

function displayBackupsList(backups) {
    const container = document.getElementById('backupsList');
    
    if (!backups || backups.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>No hay respaldos disponibles</p></div>';
        return;
    }
    
    let html = '';
    backups.slice(0, 5).forEach(backup => {
        const sizeMB = (backup.size / 1024 / 1024).toFixed(1);
        const typeBadge = backup.type === 'full' ? 'badge-primary' : 'badge-success';
        
        html += `
            <div class="backup-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6>${backup.filename}</h6>
                        <small class="text-muted">
                            ${sizeMB} MB | ${new Date(backup.created_at).toLocaleDateString()}
                        </small>
                    </div>
                    <div>
                        <span class="badge ${typeBadge}">${backup.type}</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup('${backup.filename}')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadAlertRules() {
    fetch('/api/integration/monitoring/alerts/rules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAlertRules(data.rules);
            }
        })
        .catch(error => console.error('Error cargando reglas de alertas:', error));
}

function displayAlertRules(rules) {
    const container = document.getElementById('alertRules');
    let html = '';
    
    Object.keys(rules).forEach(ruleName => {
        const rule = rules[ruleName];
        const severityColor = rule.severity === 'critical' ? 'danger' : 
                             rule.severity === 'high' ? 'warning' : 
                             rule.severity === 'medium' ? 'info' : 'success';
        
        html += `
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${ruleName.replace('_', ' ').toUpperCase()}</strong>
                        <br>
                        <small class="text-muted">
                            Umbral: ${rule.threshold} | 
                            Cooldown: ${rule.cooldown_minutes}min
                        </small>
                    </div>
                    <div>
                        <span class="badge badge-${severityColor}">${rule.severity}</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" 
                                   ${rule.enabled ? 'checked' : ''} 
                                   onchange="toggleAlertRule('${ruleName}', this.checked)">
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadActiveAlerts() {
    fetch('/api/integration/monitoring/alerts/active')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayActiveAlerts(data.alerts);
            }
        })
        .catch(error => console.error('Error cargando alertas activas:', error));
}

function displayActiveAlerts(alerts) {
    const container = document.getElementById('recentAlerts');
    
    if (!alerts || alerts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>No hay alertas activas</p></div>';
        return;
    }
    
    let html = '';
    alerts.slice(0, 5).forEach(alert => {
        const severityClass = `alert-${alert.severity}`;
        
        html += `
            <div class="alert-item ${severityClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${alert.product_name}</strong>
                        <br>
                        <small>${alert.message}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-success" onclick="resolveAlert(${alert.id})">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
                <small class="text-muted">${new Date(alert.created_at).toLocaleTimeString()}</small>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Funciones de acción
function refreshAllData() {
    loadDashboardData();
    loadIntegrations();
    loadBackups();
    loadAlertRules();
    loadActiveAlerts();
    addActivityLog('Sistema', 'Datos actualizados manualmente', 'info');
}

function startAllServices() {
    startMonitoring();
    startAutoSync();
    addActivityLog('Sistema', 'Todos los servicios iniciados', 'success');
}

function syncMarketPrices() {
    fetch('/api/integration/market-prices/sync', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Precios de mercado sincronizados', 'success');
                addActivityLog('Integración', 'Precios de mercado sincronizados', 'success');
            } else {
                showAlert('Error sincronizando precios: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error sincronizando precios', 'error');
        });
}

function syncSupplierData() {
    fetch('/api/integration/supplier-data/sync', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Datos de proveedores sincronizados', 'success');
                addActivityLog('Integración', 'Datos de proveedores sincronizados', 'success');
            } else {
                showAlert('Error sincronizando proveedores: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error sincronizando proveedores', 'error');
        });
}

function toggleAutoSync() {
    // Implementar toggle de auto sincronización
    showAlert('Función de toggle en desarrollo', 'info');
}

function createFullBackup() {
    fetch('/api/integration/backup/create-full', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Respaldo completo creado exitosamente', 'success');
                addActivityLog('Respaldo', 'Respaldo completo creado', 'success');
                loadBackups();
            } else {
                showAlert('Error creando respaldo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error creando respaldo', 'error');
        });
}

function createDataBackup() {
    fetch('/api/integration/backup/create-data', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Respaldo de datos creado exitosamente', 'success');
                addActivityLog('Respaldo', 'Respaldo de datos creado', 'success');
                loadBackups();
            } else {
                showAlert('Error creando respaldo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error creando respaldo', 'error');
        });
}

function cleanupBackups() {
    fetch('/api/integration/backup/cleanup', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                addActivityLog('Respaldo', 'Respaldos antiguos limpiados', 'info');
                loadBackups();
            } else {
                showAlert('Error limpiando respaldos: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error limpiando respaldos', 'error');
        });
}

function downloadBackup(filename) {
    window.open(`/api/integration/backup/download/${filename}`, '_blank');
}

function startMonitoring() {
    fetch('/api/integration/monitoring/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Monitoreo iniciado', 'success');
                addActivityLog('Monitoreo', 'Servicio de monitoreo iniciado', 'success');
            } else {
                showAlert('Error iniciando monitoreo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error iniciando monitoreo', 'error');
        });
}

function stopMonitoring() {
    fetch('/api/integration/monitoring/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Monitoreo detenido', 'warning');
                addActivityLog('Monitoreo', 'Servicio de monitoreo detenido', 'warning');
            } else {
                showAlert('Error deteniendo monitoreo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deteniendo monitoreo', 'error');
        });
}

function startAutoSync() {
    fetch('/api/integration/auto-sync/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Auto sincronización iniciada', 'success');
                addActivityLog('Integración', 'Auto sincronización iniciada', 'success');
            } else {
                showAlert('Error iniciando auto sync: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error iniciando auto sync', 'error');
        });
}

function stopAutoSync() {
    fetch('/api/integration/auto-sync/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Auto sincronización detenida', 'warning');
                addActivityLog('Integración', 'Auto sincronización detenida', 'warning');
            } else {
                showAlert('Error deteniendo auto sync: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deteniendo auto sync', 'error');
        });
}

function toggleAlertRule(ruleName, enabled) {
    const rules = {};
    rules[ruleName] = { enabled: enabled };
    
    fetch('/api/integration/monitoring/alerts/rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(rules)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Regla ${ruleName} ${enabled ? 'activada' : 'desactivada'}`, 'success');
            addActivityLog('Monitoreo', `Regla ${ruleName} ${enabled ? 'activada' : 'desactivada'}`, 'info');
        } else {
            showAlert('Error actualizando regla: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error actualizando regla', 'error');
    });
}

function resolveAlert(alertId) {
    fetch(`/api/integration/monitoring/alerts/resolve/${alertId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Alerta resuelta', 'success');
                addActivityLog('Monitoreo', `Alerta ${alertId} resuelta`, 'success');
                loadActiveAlerts();
            } else {
                showAlert('Error resolviendo alerta: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error resolviendo alerta', 'error');
        });
}

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        loadDashboardData();
        loadActiveAlerts();
    }, 30000); // Actualizar cada 30 segundos
}

function addActivityLog(source, message, type) {
    const logContainer = document.getElementById('activityLog');
    const timestamp = new Date().toLocaleTimeString();
    const typeClass = type === 'success' ? 'text-success' : 
                     type === 'error' ? 'text-danger' : 
                     type === 'warning' ? 'text-warning' : 'text-info';
    
    const logEntry = document.createElement('div');
    logEntry.className = 'mb-2';
    logEntry.innerHTML = `
        <small class="text-muted">[${timestamp}]</small>
        <span class="${typeClass}"><strong>${source}:</strong></span>
        <span>${message}</span>
    `;
    
    logContainer.insertBefore(logEntry, logContainer.firstChild);
    
    // Mantener solo los últimos 50 logs
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.insertBefore(alertDiv, document.body.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Limpiar intervalos al salir
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}



