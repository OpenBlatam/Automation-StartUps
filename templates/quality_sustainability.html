{% extends "base.html" %}

{% block title %}Calidad & Sostenibilidad{% endblock %}

{% block extra_css %}
<style>
    .quality-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: white;
    }
    
    .quality-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 15px rgba(0,123,255,0.1);
    }
    
    .sustainability-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: white;
    }
    
    .sustainability-card:hover {
        border-color: #28a745;
        box-shadow: 0 4px 15px rgba(40,167,69,0.1);
    }
    
    .quality-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-excellent { background-color: #d4edda; color: #155724; }
    .status-good { background-color: #d1ecf1; color: #0c5460; }
    .status-fair { background-color: #fff3cd; color: #856404; }
    .status-poor { background-color: #f8d7da; color: #721c24; }
    .status-rejected { background-color: #f5c6cb; color: #721c24; }
    
    .compliance-item {
        border-left: 4px solid;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .compliance-safety { border-left-color: #dc3545; }
    .compliance-quality { border-left-color: #007bff; }
    .compliance-environmental { border-left-color: #28a745; }
    .compliance-regulatory { border-left-color: #ffc107; }
    
    .traceability-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
    }
    
    .sustainability-goal {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
    }
    
    .goal-progress {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .goal-progress-bar {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .goal-on-track { background-color: #28a745; }
    .goal-at-risk { background-color: #ffc107; }
    .goal-behind { background-color: #dc3545; }
    .goal-achieved { background-color: #17a2b8; }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-card.sustainability {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .metric-card.quality {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .carbon-footprint {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    
    .waste-management {
        background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    
    .environmental-impact {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .impact-very-low { background-color: #d4edda; color: #155724; }
    .impact-low { background-color: #d1ecf1; color: #0c5460; }
    .impact-medium { background-color: #fff3cd; color: #856404; }
    .impact-high { background-color: #f8d7da; color: #721c24; }
    .impact-very-high { background-color: #f5c6cb; color: #721c24; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-check-circle text-primary"></i> Calidad & 
                        <i class="fas fa-leaf text-success"></i> Sostenibilidad
                    </h1>
                    <p class="text-muted">Gestión de calidad, trazabilidad y sostenibilidad ambiental</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="createQualityCheck()">
                        <i class="fas fa-plus"></i> Verificación de Calidad
                    </button>
                    <button class="btn btn-success" onclick="recordEnvironmentalMetric()">
                        <i class="fas fa-leaf"></i> Métrica Ambiental
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Calidad & Sostenibilidad -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="quality-card">
                <h5 class="mb-3">
                    <i class="fas fa-tachometer-alt text-primary"></i> Dashboard Calidad & Sostenibilidad
                    <span class="badge badge-primary pulse" id="dashboardStatus">Actualizando...</span>
                </h5>
                <div class="row" id="dashboardContainer">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="metric-card quality">
                            <div class="metric-value" id="totalQualityChecks">-</div>
                            <div class="metric-label">Verificaciones de Calidad</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="metric-card sustainability">
                            <div class="metric-value" id="totalEnvironmentalMetrics">-</div>
                            <div class="metric-label">Métricas Ambientales</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="metric-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                            <div class="metric-value" id="pendingComplianceReviews">-</div>
                            <div class="metric-label">Revisiones Pendientes</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="metric-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            <div class="metric-value" id="sustainabilityGoalsCount">-</div>
                            <div class="metric-label">Objetivos de Sostenibilidad</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calidad -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="quality-card">
                <h5 class="mb-3">
                    <i class="fas fa-check-circle text-primary"></i> Verificación de Calidad
                </h5>
                <div class="mb-3">
                    <label for="qualityProductSelect" class="form-label">Producto</label>
                    <select class="form-select" id="qualityProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="batchNumber" class="form-label">Número de Lote</label>
                    <input type="text" class="form-control" id="batchNumber" placeholder="Ej: LOT001">
                </div>
                <div class="mb-3">
                    <label for="inspectorId" class="form-label">Inspector</label>
                    <input type="text" class="form-control" id="inspectorId" placeholder="ID del inspector">
                </div>
                <div class="mb-3">
                    <label for="qualityStatus" class="form-label">Estado de Calidad</label>
                    <select class="form-select" id="qualityStatus">
                        <option value="excellent">Excelente</option>
                        <option value="good">Bueno</option>
                        <option value="fair">Regular</option>
                        <option value="poor">Malo</option>
                        <option value="rejected">Rechazado</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="createQualityCheck()">
                    <i class="fas fa-plus"></i> Crear Verificación
                </button>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="quality-card">
                <h5 class="mb-3">Historial de Calidad</h5>
                <div class="mb-3">
                    <label for="historyProductSelect" class="form-label">Producto</label>
                    <select class="form-select" id="historyProductSelect">
                        <option value="">Todos los productos...</option>
                    </select>
                </div>
                <button class="btn btn-info" onclick="loadQualityHistory()">
                    <i class="fas fa-history"></i> Cargar Historial
                </button>
                <div id="qualityHistoryContainer" class="mt-3">
                    <div class="text-center text-muted">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>Selecciona un producto para ver historial</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trazabilidad -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="quality-card">
                <h5 class="mb-3">
                    <i class="fas fa-search text-info"></i> Trazabilidad de Productos
                </h5>
                <div class="mb-3">
                    <label for="traceabilityProductSelect" class="form-label">Producto</label>
                    <select class="form-select" id="traceabilityProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="traceabilityBatch" class="form-label">Número de Lote (Opcional)</label>
                    <input type="text" class="form-control" id="traceabilityBatch" placeholder="Ej: LOT001">
                </div>
                <button class="btn btn-info" onclick="loadTraceability()">
                    <i class="fas fa-search"></i> Buscar Trazabilidad
                </button>
                <div id="traceabilityContainer" class="mt-3">
                    <div class="text-center text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p>Selecciona un producto para ver trazabilidad</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="quality-card">
                <h5 class="mb-3">Cumplimiento</h5>
                <div id="complianceContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando cumplimiento...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sostenibilidad -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="sustainability-card">
                <h5 class="mb-3">
                    <i class="fas fa-leaf text-success"></i> Métricas Ambientales
                </h5>
                <div class="mb-3">
                    <label for="metricType" class="form-label">Tipo de Métrica</label>
                    <select class="form-select" id="metricType">
                        <option value="carbon_footprint">Huella de Carbono</option>
                        <option value="water_usage">Uso de Agua</option>
                        <option value="energy_consumption">Consumo de Energía</option>
                        <option value="waste_generation">Generación de Residuos</option>
                        <option value="recycling_rate">Tasa de Reciclaje</option>
                        <option value="renewable_energy">Energía Renovable</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="metricValue" class="form-label">Valor</label>
                    <input type="number" class="form-control" id="metricValue" placeholder="0.0">
                </div>
                <div class="mb-3">
                    <label for="metricUnit" class="form-label">Unidad</label>
                    <input type="text" class="form-control" id="metricUnit" placeholder="kg, L, kWh, etc.">
                </div>
                <div class="mb-3">
                    <label for="metricSource" class="form-label">Fuente</label>
                    <input type="text" class="form-control" id="metricSource" placeholder="manufacturing, transportation, etc.">
                </div>
                <div class="mb-3">
                    <label for="metricLocation" class="form-label">Ubicación</label>
                    <input type="text" class="form-control" id="metricLocation" placeholder="Ubicación">
                </div>
                <button class="btn btn-success" onclick="recordEnvironmentalMetric()">
                    <i class="fas fa-leaf"></i> Registrar Métrica
                </button>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="sustainability-card">
                <h5 class="mb-3">Huella de Carbono</h5>
                <div class="mb-3">
                    <label for="carbonProductSelect" class="form-label">Producto</label>
                    <select class="form-select" id="carbonProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="carbonScope" class="form-label">Alcance</label>
                    <select class="form-select" id="carbonScope">
                        <option value="scope1">Alcance 1</option>
                        <option value="scope2">Alcance 2</option>
                        <option value="scope3" selected>Alcance 3</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="calculateCarbonFootprint()">
                    <i class="fas fa-calculator"></i> Calcular Huella
                </button>
                <div id="carbonFootprintResults" class="mt-3">
                    <div class="text-center text-muted">
                        <i class="fas fa-leaf fa-3x mb-3"></i>
                        <p>Selecciona un producto para calcular huella de carbono</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Objetivos de Sostenibilidad -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="sustainability-card">
                <h5 class="mb-3">
                    <i class="fas fa-bullseye text-warning"></i> Objetivos de Sostenibilidad
                </h5>
                <div id="sustainabilityGoalsContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando objetivos...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="sustainability-card">
                <h5 class="mb-3">Gestión de Residuos</h5>
                <div class="mb-3">
                    <label for="wasteProductSelect" class="form-label">Producto</label>
                    <select class="form-select" id="wasteProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="wasteType" class="form-label">Tipo de Residuo</label>
                    <select class="form-select" id="wasteType">
                        <option value="hazardous">Peligroso</option>
                        <option value="non_hazardous">No Peligroso</option>
                        <option value="recyclable">Reciclable</option>
                        <option value="organic">Orgánico</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="wasteQuantity" class="form-label">Cantidad</label>
                    <input type="number" class="form-control" id="wasteQuantity" placeholder="0.0">
                </div>
                <div class="mb-3">
                    <label for="wasteUnit" class="form-label">Unidad</label>
                    <input type="text" class="form-control" id="wasteUnit" placeholder="kg, L, etc.">
                </div>
                <div class="mb-3">
                    <label for="disposalMethod" class="form-label">Método de Disposición</label>
                    <select class="form-select" id="disposalMethod">
                        <option value="recycling">Reciclaje</option>
                        <option value="composting">Compostaje</option>
                        <option value="incineration">Incinación</option>
                        <option value="landfill">Vertedero</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="wasteLocation" class="form-label">Ubicación</label>
                    <input type="text" class="form-control" id="wasteLocation" placeholder="Ubicación">
                </div>
                <button class="btn btn-warning" onclick="recordWasteManagement()">
                    <i class="fas fa-trash"></i> Registrar Residuo
                </button>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="quality-card">
                <h5 class="mb-3">Distribución de Calidad</h5>
                <div class="chart-container">
                    <canvas id="qualityChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="sustainability-card">
                <h5 class="mb-3">Métricas Ambientales</h5>
                <div class="chart-container">
                    <canvas id="sustainabilityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Análisis Avanzado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="quality-card">
                <h5 class="mb-3">
                    <i class="fas fa-microscope text-purple"></i> Análisis Avanzado Combinado
                </h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="analysisType" class="form-label">Tipo de Análisis</label>
                        <select class="form-select" id="analysisType">
                            <option value="comprehensive">Completo</option>
                            <option value="quality">Solo Calidad</option>
                            <option value="sustainability">Solo Sostenibilidad</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary mt-4" onclick="runAdvancedAnalysis()">
                            <i class="fas fa-microscope"></i> Ejecutar Análisis
                        </button>
                    </div>
                </div>
                <div id="advancedAnalysisResults">
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>Ejecuta un análisis avanzado para ver resultados</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log de Actividad -->
    <div class="row">
        <div class="col-12">
            <div class="quality-card">
                <h5 class="mb-3">
                    <i class="fas fa-history text-secondary"></i> Log de Actividad Calidad & Sostenibilidad
                </h5>
                <div id="activityLog" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div class="text-muted">Esperando actividad...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};
let autoRefreshInterval;

// Cargar datos al inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    loadProducts();
    loadCompliance();
    loadSustainabilityGoals();
    
    // Iniciar actualización automática
    startAutoRefresh();
});

function loadDashboard() {
    fetch('/api/quality-sustainability/quality-sustainability/dashboard')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboard(data.dashboard);
            }
        })
        .catch(error => console.error('Error cargando dashboard:', error));
}

function updateDashboard(dashboard) {
    // Actualizar métricas combinadas
    document.getElementById('totalQualityChecks').textContent = dashboard.combined.total_quality_checks;
    document.getElementById('totalEnvironmentalMetrics').textContent = dashboard.combined.total_environmental_metrics;
    document.getElementById('pendingComplianceReviews').textContent = dashboard.combined.pending_compliance_reviews;
    document.getElementById('sustainabilityGoalsCount').textContent = dashboard.combined.sustainability_goals_count;
    
    document.getElementById('dashboardStatus').textContent = 'Actualizado';
    document.getElementById('dashboardStatus').className = 'badge badge-success';
}

function loadProducts() {
    fetch('/api/products')
        .then(response => response.json())
        .then(data => {
            const selects = ['qualityProductSelect', 'historyProductSelect', 'traceabilityProductSelect', 'carbonProductSelect', 'wasteProductSelect'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                
                if (data.products) {
                    data.products.forEach(product => {
                        const option = new Option(product.name, product.id);
                        select.add(option);
                    });
                }
            });
        })
        .catch(error => console.error('Error cargando productos:', error));
}

function createQualityCheck() {
    const productId = document.getElementById('qualityProductSelect').value;
    const batchNumber = document.getElementById('batchNumber').value;
    const inspectorId = document.getElementById('inspectorId').value;
    const qualityStatus = document.getElementById('qualityStatus').value;
    
    if (!productId || !batchNumber || !inspectorId) {
        showAlert('Completa todos los campos requeridos', 'warning');
        return;
    }
    
    fetch('/api/quality-sustainability/quality/create-check', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: parseInt(productId),
            batch_number: batchNumber,
            inspector_id: inspectorId,
            quality_status: qualityStatus,
            temperature: 22.5,
            humidity: 45.0,
            weight: 1.2,
            defects: [],
            notes: 'Verificación de calidad estándar'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Verificación de calidad creada exitosamente', 'success');
            addActivityLog('Calidad', `Verificación creada: ${data.quality_check.id}`, 'success');
            
            // Limpiar formulario
            document.getElementById('qualityProductSelect').value = '';
            document.getElementById('batchNumber').value = '';
            document.getElementById('inspectorId').value = '';
            document.getElementById('qualityStatus').value = 'excellent';
        } else {
            showAlert('Error creando verificación: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error creando verificación', 'error');
    });
}

function loadQualityHistory() {
    const productId = document.getElementById('historyProductSelect').value;
    
    fetch(`/api/quality-sustainability/quality/history?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayQualityHistory(data.quality_history);
            } else {
                showAlert('Error cargando historial: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error cargando historial', 'error');
        });
}

function displayQualityHistory(history) {
    const container = document.getElementById('qualityHistoryContainer');
    
    if (!history.quality_checks || history.quality_checks.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>No hay verificaciones de calidad</p></div>';
        return;
    }
    
    let html = '';
    history.quality_checks.slice(0, 10).forEach(check => {
        const statusClass = `status-${check.quality_status}`;
        
        html += `
            <div class="traceability-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>Lote: ${check.batch_number}</h6>
                        <p class="mb-1">Inspector: ${check.inspector_id}</p>
                        <p class="mb-1">Fecha: ${new Date(check.check_date).toLocaleDateString()}</p>
                        ${check.temperature ? `<p class="mb-1">Temperatura: ${check.temperature}°C</p>` : ''}
                        ${check.humidity ? `<p class="mb-1">Humedad: ${check.humidity}%</p>` : ''}
                        ${check.defects && check.defects.length > 0 ? `<p class="mb-1">Defectos: ${check.defects.join(', ')}</p>` : ''}
                    </div>
                    <div>
                        <span class="quality-status ${statusClass}">${check.quality_status}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadTraceability() {
    const productId = document.getElementById('traceabilityProductSelect').value;
    const batchNumber = document.getElementById('traceabilityBatch').value;
    
    if (!productId) {
        showAlert('Selecciona un producto', 'warning');
        return;
    }
    
    fetch(`/api/quality-sustainability/traceability/product/${productId}?batch_number=${batchNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTraceability(data.traceability);
            } else {
                showAlert('Error cargando trazabilidad: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error cargando trazabilidad', 'error');
        });
}

function displayTraceability(traceability) {
    const container = document.getElementById('traceabilityContainer');
    
    if (!traceability.traceability_records || traceability.traceability_records.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>No hay registros de trazabilidad</p></div>';
        return;
    }
    
    let html = '';
    traceability.traceability_records.forEach(record => {
        html += `
            <div class="traceability-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>${record.event_type.replace('_', ' ').toUpperCase()}</h6>
                        <p class="mb-1">Ubicación: ${record.location}</p>
                        <p class="mb-1">Actor: ${record.actor_id} (${record.actor_type})</p>
                        <p class="mb-1">Fecha: ${new Date(record.timestamp).toLocaleString()}</p>
                        ${record.previous_location ? `<p class="mb-1">Desde: ${record.previous_location}</p>` : ''}
                        ${record.next_location ? `<p class="mb-1">Hacia: ${record.next_location}</p>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadCompliance() {
    fetch('/api/quality-sustainability/compliance/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCompliance(data.compliance_status);
            }
        })
        .catch(error => console.error('Error cargando cumplimiento:', error));
}

function displayCompliance(compliance) {
    const container = document.getElementById('complianceContainer');
    
    if (!compliance.compliance_requirements || compliance.compliance_requirements.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>No hay requisitos de cumplimiento</p></div>';
        return;
    }
    
    let html = '';
    compliance.compliance_requirements.forEach(req => {
        const categoryClass = `compliance-${req.category}`;
        const needsReview = req.needs_review ? 'badge badge-warning' : 'badge badge-success';
        const reviewText = req.needs_review ? 'Revisión Pendiente' : 'Al Día';
        
        html += `
            <div class="compliance-item ${categoryClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>${req.name}</h6>
                        <p class="mb-1">${req.description}</p>
                        <p class="mb-1">Frecuencia: ${req.check_frequency} días</p>
                        ${req.last_check ? `<p class="mb-1">Última revisión: ${new Date(req.last_check).toLocaleDateString()}</p>` : ''}
                        ${req.next_check ? `<p class="mb-1">Próxima revisión: ${new Date(req.next_check).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div>
                        <span class="${needsReview}">${reviewText}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function recordEnvironmentalMetric() {
    const metricType = document.getElementById('metricType').value;
    const value = document.getElementById('metricValue').value;
    const unit = document.getElementById('metricUnit').value;
    const source = document.getElementById('metricSource').value;
    const location = document.getElementById('metricLocation').value;
    
    if (!value || !unit || !source || !location) {
        showAlert('Completa todos los campos requeridos', 'warning');
        return;
    }
    
    fetch('/api/quality-sustainability/sustainability/record-metric', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            metric_type: metricType,
            product_id: 1,
            value: parseFloat(value),
            unit: unit,
            source: source,
            location: location,
            verified: false,
            notes: 'Métrica ambiental registrada'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Métrica ambiental registrada exitosamente', 'success');
            addActivityLog('Sostenibilidad', `Métrica registrada: ${data.metric.id}`, 'success');
            
            // Limpiar formulario
            document.getElementById('metricValue').value = '';
            document.getElementById('metricUnit').value = '';
            document.getElementById('metricSource').value = '';
            document.getElementById('metricLocation').value = '';
        } else {
            showAlert('Error registrando métrica: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error registrando métrica', 'error');
    });
}

function calculateCarbonFootprint() {
    const productId = document.getElementById('carbonProductSelect').value;
    const scope = document.getElementById('carbonScope').value;
    
    if (!productId) {
        showAlert('Selecciona un producto', 'warning');
        return;
    }
    
    fetch(`/api/quality-sustainability/sustainability/carbon-footprint/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            scope: scope
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayCarbonFootprint(data.carbon_footprint);
            addActivityLog('Sostenibilidad', `Huella de carbono calculada para producto ${productId}`, 'success');
        } else {
            showAlert('Error calculando huella de carbono: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error calculando huella de carbono', 'error');
    });
}

function displayCarbonFootprint(footprint) {
    const container = document.getElementById('carbonFootprintResults');
    
    container.innerHTML = `
        <div class="carbon-footprint">
            <h5>Huella de Carbono</h5>
            <div class="metric-value">${footprint.co2_equivalent.toFixed(2)} kg CO₂e</div>
            <p>Alcance: ${footprint.scope.toUpperCase()}</p>
            <p>Categoría: ${footprint.category}</p>
            <p>Metodología: ${footprint.methodology}</p>
            <small>Fecha: ${new Date(footprint.measurement_date).toLocaleDateString()}</small>
        </div>
    `;
}

function loadSustainabilityGoals() {
    fetch('/api/quality-sustainability/sustainability/goals')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySustainabilityGoals(data.sustainability_goals);
            }
        })
        .catch(error => console.error('Error cargando objetivos:', error));
}

function displaySustainabilityGoals(goals) {
    const container = document.getElementById('sustainabilityGoalsContainer');
    
    if (!goals.goals_progress || goals.goals_progress.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>No hay objetivos de sostenibilidad</p></div>';
        return;
    }
    
    let html = '';
    goals.goals_progress.forEach(goal => {
        const progressClass = `goal-${goal.status.replace('_', '-')}`;
        
        html += `
            <div class="sustainability-goal">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>${goal.name}</h6>
                        <p class="mb-1">Progreso: ${goal.progress_percentage.toFixed(1)}%</p>
                        <p class="mb-1">Fecha objetivo: ${new Date(goal.target_date).toLocaleDateString()}</p>
                    </div>
                    <div>
                        <span class="badge badge-${goal.status === 'on_track' ? 'success' : goal.status === 'at_risk' ? 'warning' : goal.status === 'behind' ? 'danger' : 'info'}">${goal.status}</span>
                    </div>
                </div>
                <div class="goal-progress">
                    <div class="goal-progress-bar ${progressClass}" style="width: ${goal.progress_percentage}%"></div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function recordWasteManagement() {
    const productId = document.getElementById('wasteProductSelect').value;
    const wasteType = document.getElementById('wasteType').value;
    const quantity = document.getElementById('wasteQuantity').value;
    const unit = document.getElementById('wasteUnit').value;
    const disposalMethod = document.getElementById('disposalMethod').value;
    const location = document.getElementById('wasteLocation').value;
    
    if (!productId || !quantity || !unit || !location) {
        showAlert('Completa todos los campos requeridos', 'warning');
        return;
    }
    
    fetch('/api/quality-sustainability/sustainability/waste-management', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: parseInt(productId),
            waste_type: wasteType,
            quantity: parseFloat(quantity),
            unit: unit,
            disposal_method: disposalMethod,
            location: location,
            cost: 0.0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Gestión de residuos registrada exitosamente', 'success');
            addActivityLog('Sostenibilidad', `Residuo registrado: ${data.waste_record.id}`, 'success');
            
            // Limpiar formulario
            document.getElementById('wasteProductSelect').value = '';
            document.getElementById('wasteQuantity').value = '';
            document.getElementById('wasteUnit').value = '';
            document.getElementById('wasteLocation').value = '';
        } else {
            showAlert('Error registrando residuo: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error registrando residuo', 'error');
    });
}

function runAdvancedAnalysis() {
    const analysisType = document.getElementById('analysisType').value;
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
    button.disabled = true;
    
    fetch('/api/quality-sustainability/quality-sustainability/advanced-analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            analysis_type: analysisType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAdvancedAnalysis(data.results);
            addActivityLog('Análisis', `Análisis ${analysisType} completado`, 'success');
        } else {
            showAlert('Error en análisis: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error en análisis', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function displayAdvancedAnalysis(results) {
    const container = document.getElementById('advancedAnalysisResults');
    
    let html = '<div class="row">';
    
    if (results.quality_analysis) {
        html += `
            <div class="col-md-6">
                <h6>Análisis de Calidad</h6>
                <div class="mb-3">
                    <strong>Verificaciones:</strong> ${results.quality_analysis.total_checks}
                </div>
                <div class="mb-3">
                    <strong>Revisiones Pendientes:</strong> ${results.quality_analysis.pending_reviews}
                </div>
            </div>
        `;
    }
    
    if (results.sustainability_analysis) {
        html += `
            <div class="col-md-6">
                <h6>Análisis de Sostenibilidad</h6>
                <div class="mb-3">
                    <strong>Métricas:</strong> ${results.sustainability_analysis.total_metrics}
                </div>
                <div class="mb-3">
                    <strong>Objetivos:</strong> ${results.sustainability_analysis.goals_count}
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    container.innerHTML = html;
}

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        loadDashboard();
        loadCompliance();
        loadSustainabilityGoals();
    }, 30000); // Actualizar cada 30 segundos
}

function addActivityLog(source, message, type) {
    const logContainer = document.getElementById('activityLog');
    const timestamp = new Date().toLocaleTimeString();
    const typeClass = type === 'success' ? 'text-success' : 
                     type === 'error' ? 'text-danger' : 
                     type === 'warning' ? 'text-warning' : 'text-info';
    
    const logEntry = document.createElement('div');
    logEntry.className = 'mb-2';
    logEntry.innerHTML = `
        <small class="text-muted">[${timestamp}]</small>
        <span class="${typeClass}"><strong>${source}:</strong></span>
        <span>${message}</span>
    `;
    
    logContainer.insertBefore(logEntry, logContainer.firstChild);
    
    // Mantener solo los últimos 50 logs
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.insertBefore(alertDiv, document.body.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Limpiar intervalos al salir
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}



